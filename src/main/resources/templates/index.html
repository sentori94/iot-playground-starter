<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IOT Playground</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <span class="navbar-brand">IOT Playground</span>
    </div>
</nav>


<main class="container py-4">
    <div th:if="${toast}" class="alert alert-info" th:text="${toast}"></div>

    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">Dashboard minimal</h5>
            <div class="d-flex gap-2">
                <form class="row gy-2 gx-2 align-items-end" method="post" action="/simulate" oninput="previewSensors()">
                    <div class="col-auto">
                        <label>Utilisateur</label>
                        <input type="text" name="username" required minlength="3" maxlength="20" pattern="[A-Za-z0-9._-]{3,20}" title="3‚Äì20 caract√®res: lettres, chiffres, . _ -"/>
                    </div>
                    <div class="col-auto">
                        <label class="form-label">Nombre de capteurs (1‚Äì20)</label>
                        <input class="form-control" type="number" id="sensorsCount" name="sensorsCount" min="1" max="20" value="1" required>
                    </div>
                    <div class="col-auto">
                        <label class="form-label">Count</label>
                        <input class="form-control" type="number" name="count" value="10" min="1" max="1000">
                    </div>
                    <div class="col-auto">
                        <label class="form-label">Interval (ms)</label>
                        <input class="form-control" type="number" name="intervalMs" value="200" min="10">
                    </div>
                    <div class="col-auto">
                        <button id="launch-btn" class="btn btn-primary" type="submit" th:disabled="${running}">
                            Lancer la simulation
                        </button>
                    </div>

                    <div id="running-badge" class="col-auto" th:if="${running}">
                        <span class="badge bg-warning text-dark">Ex√©cution en cours‚Ä¶</span>
                    </div>
                </form>

                <!-- Aper√ßu des IDs g√©n√©r√©s -->
                <div id="sensorPreview" style="margin-top:8px; font-family:monospace;"></div>

            </div>

            <!-- Bouton pour t√©l√©charger les rapports -->
            <div style="margin-top:12px;">
                <button id="download-reports-btn" class="btn btn-success" onclick="downloadReports()">
                    üì• T√©l√©charger les rapports (ZIP)
                </button>
            </div>

            <!-- Lien Grafana (masqu√© tant qu‚Äôinexistant) -->
            <div id="grafana-link" style="display:none; margin-top:12px;">
                <a id="grafana-url" href="#" target="_blank" rel="noopener">Ouvrir le dashboard Grafana</a>
            </div>

            <!-- Barre de progression simple -->
            <div id="progress-container" style="display:none; margin-top:12px; width:100%; background:#eee; border-radius:6px;">
                <div id="progress-bar" style="width:0%; height:20px; background:#4caf50; color:#fff; text-align:center; border-radius:6px;">0%</div>
            </div>

            <!-- Expose l'ID du run √† JS -->
            <div id="cfg" th:if="${runId != null}" th:attr="data-run-id=${runId}"></div>

            <hr/>
            <p class="text-muted mb-1">Statut application</p>
            <ul class="mb-0">
                <li>Heure serveur : <span th:text="${#dates.format(#dates.createNow(),'yyyy-MM-dd HH:mm:ss')}">--</span></li>
                <li>Env : <span th:text="${@environment.getProperty('spring.profiles.active','default')}">default</span></li>
                <li>Niveau root log : <span th:text="${@environment.getProperty('logging.level.root','INFO')}">INFO</span></li>
                <li>IP serveur :
                    <span th:text="${@serverInfo.ip}">127.0.0.1</span>
                </li>
                <li>DNS serveur :
                    <span th:text="${@serverInfo.hostname}">localhost</span>
                </li>
            </ul>
        </div>
    </div>
</main>


<script th:inline="javascript">
    // URLs (r√©solues par Thymeleaf)
    const RUNS_API = /*[[@{/api/runs/}]]*/ '/api/runs/';

    // R√©cup√®re l'ID si pr√©sent (la page vient de lancer une simu)
    const cfgEl = document.getElementById('cfg');
    const currentId = cfgEl ? cfgEl.dataset.runId : null;

    // -- UI helpers --
    const barWrap = document.getElementById('progress-container');
    const bar     = document.getElementById('progress-bar');
    const linkBox = document.getElementById('grafana-link');
    const linkA   = document.getElementById('grafana-url');

    let animTimer = null, pollTimer = null, animWidth = 0;

    function startProgress() {
      barWrap.style.display = 'block';
      animWidth = 0;
      clearInterval(animTimer);
      animTimer = setInterval(() => {
        if (animWidth < 90) {
          animWidth++;
          bar.style.width = animWidth + '%';
          bar.textContent = animWidth + '%';
        }
      }, 100);
    }

    function finishProgress() {
      clearInterval(animTimer);
      bar.style.width = '100%';
      bar.textContent = '100%';
      setTimeout(() => {
        barWrap.style.display = 'none';
        bar.style.width = '0%';
        bar.textContent = '0%';
      }, 600);
    }

  function unlockUI() {
    const btn = document.getElementById('launch-btn');
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Lancer la simulation';
    }
    const badge = document.getElementById('running-badge');
    if (badge) badge.style.display = 'none'; // ou badge.classList.add('d-none') si Bootstrap
  }

    async function pollRun(runId) {
      try {
        const res = await fetch(RUNS_API + runId, { headers: { 'Accept': 'application/json' }});
        if (!res.ok) return; // 404/500 -> on r√©essaie au tick suivant
        const run = await res.json();

        // Quand le run est termin√©
        if (run.status === 'SUCCESS' || run.status === 'FINISHED' || run.status === 'FAILED') {
          clearInterval(pollTimer);
          finishProgress();
          unlockUI(); // << d√©grise le bouton + cache le badge

          if (run.grafanaUrl && (run.status === 'SUCCESS' || run.status === 'FINISHED')) {
            linkA.href = run.grafanaUrl;
            linkBox.style.display = 'block';
          }
        }

      } catch (e) {
        // silencieux, on retentera au tick suivant
        console.debug('poll error', e);
      }
    }

    // Auto-d√©marrage si on revient d'un lancement
    document.addEventListener('DOMContentLoaded', () => {
      if (!currentId) return;               // rien √† faire si pas de run √† suivre
      startProgress();                      // barre qui avance en attendant
      pollTimer = setInterval(() => pollRun(currentId), 1000); // 1s
      console.log('Polling run', currentId, 'via', RUNS_API);
    });

    // Fonction pour t√©l√©charger les rapports
    async function downloadReports() {
      const btn = document.getElementById('download-reports-btn');
      const originalText = btn.textContent;

      try {
        btn.disabled = true;
        btn.textContent = '‚è≥ T√©l√©chargement...';

        const response = await fetch('/api/reports/download');

        if (!response.ok) {
          throw new Error('Erreur lors du t√©l√©chargement: ' + response.status);
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'simulation-reports.zip';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        console.log('Rapports t√©l√©charg√©s avec succ√®s');
      } catch (error) {
        console.error('Erreur lors du t√©l√©chargement des rapports:', error);
        alert('Erreur lors du t√©l√©chargement des rapports. V√©rifiez la console pour plus de d√©tails.');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }
</script>
</body>
</html>
